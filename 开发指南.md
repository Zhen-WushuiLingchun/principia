# 开发指南 (Developer Guide)

## 架构概览

The Principia 采用现代化的前后端分离架构，由基于 React 的前端和基于 Flask 的后端组成。

### 前端 (`/principia`)
使用 **Vite + React + TypeScript** 构建。

-   **核心组件**:
    -   `App.tsx`: 主应用程序编排器，管理内容、布局和 API 交互的状态。
    -   `Editor.tsx`: 封装 Monaco Editor，提供强大的代码编辑体验（支持 LaTeX/Markdown 语法高亮）。
    -   `Renderer.tsx`: 处理实时预览，使用 `react-markdown` 和 `react-latex-next`。包含自定义逻辑以在 Markdown 模式下渲染 LaTeX 颜色命令。
    -   `HandwritingCanvas.tsx`: 自定义 HTML5 Canvas 实现，支持多页手写和橡皮擦逻辑。
    -   `InteractiveBadge.tsx`: 用于显示 AI 分析结果和托管交互式可视化 iframe 的 UI 组件。
    -   `SettingsSidebar.tsx`: 管理用户对 API 端点和密钥的配置。

-   **状态管理**:
    -   主要使用本地组件状态 (`useState`) 控制 UI 切换。
    -   大量使用 Ref Hooks (`useRef`) 处理 Canvas 和 Editor 的交互以保证高性能。

### 后端 (`app.py`)
使用 **Flask** 构建。

-   **API 端点**:
    -   `/api/analyze` (POST): 处理“推理”请求。调用 LLM 解释概念并生成 HTML/JS 物理模拟代码。
    -   `/api/ocr` (POST): 处理“视觉”请求。接收 base64 图片并返回 LaTeX 转录，包含特定提示词以进行颜色检测。
    -   `/api/convert` (POST): 处理格式转换（LaTeX <-> Markdown）。包含特定的 Prompt Engineering 以保留文档结构并翻译颜色语法（如 `\textcolor` <-> HTML 标签）。
    -   `/`: 在生产环境中服务静态前端构建文件。

## 开发环境设置

1.  **环境要求**:
    -   安装 `Node.js` 和 `Python`。
    -   建议为 Python 使用虚拟环境 (`venv`)。

2.  **前端开发**:
    ```bash
    cd principia
    npm run dev
    ```
    这将启动带有热模块替换 (HMR) 的 Vite 开发服务器。

3.  **后端开发**:
    ```bash
    python app.py
    ```
    默认在 8000 端口运行。

## 关键实现细节

### 颜色保留逻辑 (Color Preservation)
本项目的一个独特功能是在格式转换过程中保留文本颜色。
-   **后端**: `/api/convert` 端点使用专门的 Prompt 指示 LLM 将 LaTeX 中的 `\textcolor{color}{text}` 映射为 Markdown 中的 `<font color="color">text</font>`（或保留兼容的 LaTeX 语法），反之亦然，不过本处的预览貌似直接tex语法就能预览。
-   **前端**: `Renderer` 组件使用正则替换逻辑，即使在 Markdown 预览模式下也能识别并渲染 `\textcolor` 命令，确保“所见即所得”的一致体验。

### AI 可视化 (Visualization)
可视化引擎的工作原理：
1.  将上下文文本发送给 LLM。
2.  请求生成一个包含物理模拟循环 (`requestAnimationFrame`) 的独立 HTML 代码片段。
3.  将此 HTML 注入到 `InteractiveBadge` 组件内的沙盒 `iframe` 中运行。

## 贡献代码

1.  Fork 本仓库。
2.  创建特性分支 (`git checkout -b feature/amazing-feature`)。
3.  提交更改。
4.  推送到分支。
5.  提交 Pull Request。
