# The Principia (Alpha) - 开发者文档

本文档面向希望了解 **The Principia** 内部架构、为代码库做出贡献或扩展其功能的开发者。

---

## 1. 架构概览

The Principia 采用 **混合客户端-服务器架构 (Hybrid Client-Server Architecture)**，旨在平衡交互性与强大的 AI 处理能力。

### 高层架构图

```mermaid
graph TD
    User[用户 / 浏览器] <--> |HTTP/WebSocket| Frontend[React + Vite 应用]
    Frontend <--> |REST API| Backend[Flask 代理服务器]
    Backend <--> |API 调用| Reasoner[推理大模型 (DeepSeek/o1)]
    Backend <--> |API 调用| VisionCoder[视觉/编程大模型 (Gemini/GPT-4o)]
    
    subgraph Browser [浏览器端]
        Frontend
        LocalStorage[API 配置存储]
        Canvas[WebGL/Three.js 渲染器]
    end
    
    subgraph Server [服务端 (本地/云端)]
        Backend
    end
```

### 1.1 前端（“外壳”）
* **技术栈**: React 18, Vite, TypeScript, Tailwind CSS, Framer Motion。
* **角色**: 处理用户输入（文本/手写），状态管理，并渲染模拟仿真。
* **核心组件**:
    * `App.tsx`: 主状态容器（内容、设置、模式）。
    * `Editor.tsx`: 文本输入区域。
    * `HandwritingCanvas.tsx`: 基于 `react-canvas-draw` 封装的墨迹捕捉组件。
    * `Renderer.tsx`: 渲染 Markdown/LaTeX 并管理“交互式徽章”（AI 触发器）。
    * `InteractiveBadge.tsx`: 触发 AI 分析流程的 UI 组件。
* **模拟运行时**: 前端在沙箱环境（使用 `new Function` 或 `iframe`）中执行 AI 生成的 JavaScript 代码，为其提供访问 `Three.js` 或 HTML5 Canvas 上下文的权限。

### 1.2 后端（“代理”）
* **技术栈**: Python, Flask, Flask-CORS。
* **角色**: 充当 AI 调用的安全代理和编排器。它通过封装提示词工程（Prompt Engineering）和多模型协调逻辑，简化了前端的复杂性。
* **为什么需要后端？**
    * 虽然前端可以直接调用 LLM，但后端允许更好地管理提示词、潜在的缓存机制，并且可以在不更新客户端代码的情况下轻松切换不同的模型提供商。
* **核心端点**:
    * `/api/analyze`: 核心的“双脑”流水线（解释 + 可视化）。
    * `/api/ocr`: 处理手写到 LaTeX 的转换。
    * `/api/convert`: 智能文档格式转换（Markdown <-> LaTeX）。

---

## 2. “双脑” AI 流水线 (The "Dual-Brain" AI Pipeline)

The Principia 的核心创新在于将认知负载分配给两种专门的模型类型。该逻辑主要驻留在 `app.py` 中。

### 阶段 1：物理学家 (推理)
* **输入**: 用户的原始文本/LaTeX 上下文 + 完整文档上下文。
* **目标**: 理解 *物理原理*。
* **提示词策略**: “你是一位专业的物理导师... 分析这个概念... 提供简短的解释... 检测语言。”
    > *（批注：其实 AI 给自己生成的提示词还挺好用的）*
* **模型**: DeepSeek-V3, OpenAI o1 (高推理能力)。

### 阶段 2：工程师 (可视化)
* **输入**: 来自阶段 1 的 *解释* + 原始上下文。
* **目标**: 编写 *可执行代码*。
* **提示词策略**: “你是一位专业的前端开发人员... 创建一个动态模拟... 使用 `requestAnimationFrame`... 从上下文中提取特定参数（如 mass=5kg）。”
* **模型**: Gemini 2.0 Flash, GPT-4o (高编程及多模态能力)。
    > *（批注：貌似生成这个东西的 AI 还不知到现在的最新 AI 是啥，你直接有啥好的直接用就得了，上条同理）*

---

## 3. 实现细节

### 3.1 手写识别 (`/api/ocr`)
* 接收 Base64 图像。
* 将其发送给视觉模型（Gemini/GPT-4o），并使用专门针对 "XeLaTeX" 输出调整的提示词。
    > *（批注：其实在后端处理这个的时候用的 KaTeX，为了渲染快，不过下载下来的应该是 XeLaTeX 吧）*
* 返回原始 LaTeX 代码并追加到编辑器中。

### 3.2 动态模拟注入
* 后端返回一个包含 `visualization` 的 JSON 对象：即原始 HTML/JS 字符串。
* 前端 (`InteractiveBadge.tsx`) 将其注入到 `iframe` 中或直接渲染。
* **安全提示**: 当前代码以用户权限运行。对于生产环境发布，需要更严格的沙箱隔离（例如 WebWorkers 或带有 CSP 的隔离 iframe）。

### 3.3 国际化 (i18n)
* 对于 *内容*，我们不使用标准的 i18n 库（如 `react-i18next`）。
* 相反，我们使用 **AI 原生 i18n**：AI 检测用户笔记的语言，并动态生成相同语言的模拟 UI（标签、按钮）。

### 3.4 智能文档格式转换 (`/api/convert`)
* **功能**: 在 Markdown (Web/笔记通用) 和 LaTeX (学术论文标准) 格式之间进行无缝切换。
* **AI 重构**: 不同于简单的正则替换，我们使用 LLM (Reasoning Model) 来理解文档的语义结构。
    * **MD -> TEX**: AI 会自动识别 Markdown 的层级（`#`, `##`）并转换为 LaTeX 的章节命令（`\section`, `\subsection`），将列表转换为 `itemize`/`enumerate` 环境，同时保留数学公式的完整性。
    * **TEX -> MD**: AI 会将复杂的 LaTeX 宏包和环境“降维”为干净的 Markdown 语法，方便在 Web 端阅读或迁移到 Notion/Obsidian。
* **上下文感知**: 转换过程中，AI 会智能处理格式嵌套，确保转换后的文档不仅语法正确，而且排版美观。
    > *（批注：除了吃 tokens 都挺好的，反正大概率比传统方法好？）*

---

## 4. 贡献指南

如果你想扩展 The Principia，以下是推荐的工作流程：

### 4.1 设置
1.  遵循 `BUILD_GUIDE.md` 设置环境。
2.  使用 VS Code 并安装 Prettier 和 ESLint 扩展。

### 4.2 改进重点领域
* **提示词工程 (Prompt Engineering)**: 调整 `app.py` 中的提示词以获得更好的模拟效果。尝试添加“思维链 (Chain of Thought)”或特定的物理约束。
* **模拟引擎**: 目前，我们要依赖 AI 编写原始的 WebGL/Canvas 代码。更好的方法可能是构建一个高级的 **"The Principia DSL"**（领域特定语言）或预构建的 React 物理组件库（弹簧、粒子、场），AI 只需进行 *配置* 而非从头编写。
* **状态管理**: 如果应用复杂度增加（例如多标签页模拟），建议从 `useState` 迁移到 `Zustand` 或 `Redux`。

---

## 5. 未来展望与扩展

> *（批注：显然下面这几条都是 AI 生成的，您看到这里如果觉得可行，其实也可以试试，真做出来了记得给我玩玩）*

The Principia 目前是一个独立的 Web 原型，但其“生成式引擎”核心具有巨大的潜力。

### 5.1 Obsidian/VS Code 插件
* **概念**: 将 The Principia 直接引入你的笔记应用中。
* **实现**: 将 React 前端移植为 Obsidian 插件。使用现有的 Python 后端（或用 JS/WASM 重写逻辑）来处理当前笔记。
* **益处**: “活的物理笔记” —— 你的方程在你输入时即刻鲜活起来。

### 5.2 原生平板应用 (iPad/Android)
* **概念**: 学生的“超级笔记本”。
* **实现**: React Native 或 Flutter。
* **特性**: 与 Apple Pencil / S-Pen 深度集成。实时手写分析（无需“识别”按钮，只需持续的后台处理）。

### 5.3 "Principia Edu" 教育平台
* **概念**: 教师工具。
* **特性**: 教师用文本编写教案，The Principia 生成完整的幻灯片，并在每一页嵌入交互式、可玩的模拟仿真。

### 5.4 "物理内核" (WASM)
* **优化**: 我们可以将提示词工程逻辑完全移至客户端，或将基于 Rust 的物理引擎编译为 WebAssembly，而不是依赖 Python 作为“代理”。
* **目标**: 离线优先能力（通过 WebGPU 在浏览器中运行 Llama 3 等本地 LLM）。

---

## 6. API 参考

### POST `/api/analyze`
**请求:**
```json
{
  "context": "F=ma",
  "fullContext": "Newton's Second Law...",
  "reasoningConfig": { ... },
  "visionConfig": { ... }
}
```
**响应:**
```json
{
  "explanation": "Newton's second law states...",
  "visualization": "<div id='sim'>...</div><script>...</script>"
}
```

### POST `/api/convert`
**请求:**
```json
{
  "content": "# Title...",
  "targetFormat": "tex",
  "reasoningConfig": { ... }
}
```